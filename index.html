<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daily Bible Reader (Interlinear)</title>
    <style>
      :root {
        --primary: #1f2d3d;
        --accent: #2f80ed;
        --bg: #f4f6fb;
        --text: #1f2937;
        --muted: #6b7280;
        --card-bg: #ffffff;
        --border: #e5e7eb;
        --accent-soft: #e8f1ff;
        --shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
        --esv-color: #1f2d3d;
        --nkrv-color: #4b5563;
        --font-main: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: var(--font-main);
        background-color: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 0;
        line-height: 1.65;
      }

      /* Header & Navigation */
      header {
        background: linear-gradient(90deg, #1f2d3d, #2c3e50);
        color: white;
        padding: 16px 7px;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin: 0;
        font-size: 1.25rem;
        letter-spacing: 0.2px;
        text-align: center;
      }

      .controls {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      select {
        padding: 7px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: white;
        font-size: 16px; /* Prevents zoom on mobile */
        box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      }

      button#loadBtn {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 8px 16px rgba(47, 128, 237, 0.25);
      }

      button#loadBtn:hover {
        background-color: #2568c9;
      }

      /* Reading Area */
      .container {
        max-width: 960px;
        margin: 0 auto;
        padding: 24px;
      }

      .reading-header {
        text-align: center;
        margin: 1.5rem 0 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border);
      }

      .reading-header h2 {
        margin: 0 0 6px;
        font-size: 1.5rem;
      }

      .reading-sub {
        margin: 0;
        color: var(--muted);
        font-size: 0.95rem;
      }

      .segment-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        margin: 0.5rem 0 1.5rem;
        flex-wrap: wrap;
      }

      .segment-controls button {
        background: white;
        border: 1px solid var(--border);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 0.9rem;
        cursor: pointer;
        box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
      }

      .segment-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        box-shadow: none;
      }

      .segment-info {
        color: var(--muted);
        font-size: 0.9rem;
      }

      .limit-note {
        text-align: center;
        color: var(--muted);
        font-size: 0.85rem;
        margin: 0 0 1.5rem;
      }

      /* Interlinear Styles */
      .verse-container {
        /* background: var(--card-bg); Removed for Chapter Card mode */
        /* margin-bottom: 16px; */
        padding: 10px;
        /* border-radius: 12px; */
        /* border: 1px solid var(--border); */
        /* box-shadow: var(--shadow); */
        border-bottom: 1px solid #f1f5f9;
        display: grid;
        grid-template-columns: 48px 1fr; /* Slightly narrower number col */
        gap: 18px;
      }

      .verse-container:last-child {
        border-bottom: none;
      }

      .verse-container:hover {
        background-color: #fcfdff;
      }

      .verse-number {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        background: #f1f5f9;
        color: var(--muted);
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        margin-top: 2px;
      }

      .verse-text {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .text-esv {
        font-size: 1.03rem;
        color: var(--esv-color);
        font-weight: 600;
      }

      .text-nkrv {
        font-size: 0.98rem;
        color: var(--nkrv-color);
        font-family: "Malgun Gothic", Dotum, sans-serif; /* Good for Korean */
        word-break: keep-all;
      }

      .text-nkrv.placeholder {
        color: #9ca3af;
        font-style: italic;
      }

      .chapter-marker {
        margin: 26px 0 12px;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--primary);
      }

      .chapter-marker span {
        background: white;
        border: 1px solid var(--border);
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 0.85rem;
        font-weight: 700;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        box-shadow: 0 6px 12px rgba(15, 23, 42, 0.06);
      }

      .chapter-line {
        flex: 1;
        height: 1px;
        background: var(--border);
      }

      /* Chapter Card Layout (Cascade by Chapter) */
      .chapter-card {
        background: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 1rem;
        overflow: hidden;
      }

      .chapter-card-header {
        background: linear-gradient(to right, #f8fafc, #ffffff);
        padding: 14px 24px;
        border-bottom: 1px solid var(--border);
        font-weight: 700;
        color: var(--primary);
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
      }

      .chapter-card-header:hover {
        background: #f1f5f9;
      }

      .chapter-card-header::before {
        content: "";
        display: block;
        width: 4px;
        height: 18px;
        background: var(--accent);
        border-radius: 2px;
      }

      .chapter-card-header .toggle-icon {
        margin-left: auto;
        transition: transform 0.3s ease;
      }

      .chapter-card.collapsed .chapter-card-header .toggle-icon {
        transform: rotate(-90deg);
      }

      .chapter-card-content {
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        max-height: 5000px; /* Arbitrary large height */
        opacity: 1;
        overflow: hidden;
      }

      .chapter-card.collapsed .chapter-card-content {
        max-height: 0;
        opacity: 0;
        border-bottom: none;
      }

      /* Hide border when collapsed to look cleaner */
      .chapter-card.collapsed {
        border-bottom-color: transparent;
      }

      .loading,
      .error {
        text-align: center;
        padding: 2rem;
        font-style: italic;
      }

      .error {
        color: #e74c3c;
      }

      .copyright-note {
        font-size: 0.8rem;
        color: var(--muted);
        margin-top: 1.75rem;
        border-top: 1px dashed var(--border);
        padding-top: 0.85rem;
        line-height: 1.5;
      }

      @media (max-width: 640px) {
        .verse-container {
          grid-template-columns: 32px 1fr; /* Keep side-by-side but narrower number */
          gap: 12px; /* Reduce gap */
          padding: 8px; /* Reduce padding */
        }

        .verse-number {
          width: 32px;
          height: 32px;
          font-size: 0.8rem;
          margin-top: 0; /* Align better */
        }
      }

      /* Copyright Note */
      .note {
        font-size: 0.8rem;
        color: #777;
        text-align: center;
        margin-top: 3rem;
        border-top: 1px solid #eee;
        padding-top: 1rem;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>말씀의 삶 과제 성경구절</h1>
      <div class="controls">
        <select id="weekSelect"></select>
        <select id="daySelect"></select>
        <button id="loadBtn">Read</button>
      </div>
    </header>

    <div class="container">
      <div id="contentArea">
        <div class="reading-header">
          <h2>Select a week and day to begin.</h2>
        </div>
      </div>

      <div class="note">
        <p>
          <strong>Note:</strong> ESV passages load via a local proxy (set
          <code>ESV_API_KEY</code> when running <code>server.js</code>). NKRV
          text loads from <code>assets/bible.json</code>. Use is intended for
          noncommercial church purposes and the ESV text is shown within API
          limits.
        </p>
      </div>
    </div>

    <script>
      // 1. The Reading Plan Data (Parsed from your CSV)
      const readingPlan = {
        "Week 1": [
          "Genesis 1-10",
          "Genesis 11-20",
          "Genesis 21-30",
          "Genesis 31-40",
          "Genesis 41-50",
        ],
        "Week 2": [
          "Exodus 1-5",
          "Exodus 6-10",
          "Exodus 11-15",
          "Exodus 16-20",
          "Exodus 32-34",
        ],
        "Week 3": [
          "Numbers 11-14",
          "Numbers 16-17",
          "Numbers 20-25",
          "Deuteronomy 1-3",
          "Deuteronomy 29-34",
        ],
        "Week 4": [
          "Joshua 1-3",
          "Joshua 4-6",
          "Joshua 7-9",
          "Joshua 10-11",
          "Joshua 23-24",
        ],
        "Week 5": [
          "Judges 1-5",
          "Judges 6-10",
          "Judges 11-15",
          "Judges 16-21",
          "Ruth 1-4",
        ],
        "Week 6": [
          "1 Samuel 1-6",
          "1 Samuel 7-12",
          "1 Samuel 13-18",
          "1 Samuel 19-24",
          "1 Samuel 25-31",
        ],
        "Week 7": [
          "2 Samuel 1-5",
          "2 Samuel 6-10",
          "2 Samuel 11-15",
          "2 Samuel 16-20",
          "2 Samuel 21-24",
        ],
        "Week 8": [
          "1 Kings 1-5",
          "1 Kings 6-10",
          "1 Kings 11-15",
          "1 Kings 16-20",
          "1 Kings 21-22",
        ],
        "Week 9": [
          "2 Kings 1-5",
          "2 Kings 6-10",
          "2 Kings 11-15",
          "2 Kings 16-20",
          "2 Kings 21-25",
        ],
        "Week 10": [
          "Ezra 1-5",
          "Ezra 6-10",
          "Nehemiah 1-6",
          "Nehemiah 7-13",
          "Esther 1-10",
        ],
        "Week 11": [
          "Matthew 1-6",
          "Matthew 7-12",
          "Matthew 13-18",
          "Matthew 19-24",
          "Matthew 25-28",
        ],
        "Week 12": [
          "Acts 1-5",
          "Acts 6-10",
          "Acts 11-16",
          "Acts 17-22",
          "Acts 23-28",
        ],
      };

      // 2. Initialize UI
      const weekSelect = document.getElementById("weekSelect");
      const daySelect = document.getElementById("daySelect");
      const loadBtn = document.getElementById("loadBtn");
      const contentArea = document.getElementById("contentArea");
      const ESV_API_URL = "/api/esv";
      const NKRV_JSON_PATH = "/assets/bible.json";
      const BOOK_MAP = {
        Genesis: "창",
        Exodus: "출",
        Leviticus: "레",
        Numbers: "민",
        Deuteronomy: "신",
        Joshua: "수",
        Judges: "삿",
        Ruth: "룻",
        "1 Samuel": "삼상",
        "2 Samuel": "삼하",
        "1 Kings": "왕상",
        "2 Kings": "왕하",
        "1 Chronicles": "대상",
        "2 Chronicles": "대하",
        Ezra: "스",
        Nehemiah: "느",
        Esther: "에",
        Job: "욥",
        Psalms: "시",
        Psalm: "시",
        Proverbs: "잠",
        Ecclesiastes: "전",
        "Song of Solomon": "아",
        "Song of Songs": "아",
        Isaiah: "사",
        Jeremiah: "렘",
        Lamentations: "애",
        Ezekiel: "겔",
        Daniel: "단",
        Hosea: "호",
        Joel: "욜",
        Amos: "암",
        Obadiah: "옵",
        Jonah: "욘",
        Micah: "미",
        Nahum: "나",
        Habakkuk: "합",
        Zephaniah: "습",
        Haggai: "학",
        Zechariah: "슥",
        Malachi: "말",
        Matthew: "마",
        Mark: "막",
        Luke: "눅",
        John: "요",
        Acts: "행",
        Romans: "롬",
        "1 Corinthians": "고전",
        "2 Corinthians": "고후",
        Galatians: "갈",
        Ephesians: "엡",
        Philippians: "빌",
        Colossians: "골",
        "1 Thessalonians": "살전",
        "2 Thessalonians": "살후",
        "1 Timothy": "딤전",
        "2 Timothy": "딤후",
        Titus: "딛",
        Philemon: "몬",
        Hebrews: "히",
        James: "약",
        "1 Peter": "벧전",
        "2 Peter": "벧후",
        "1 John": "요일",
        "2 John": "요이",
        "3 John": "요삼",
        Jude: "유",
        Revelation: "계",
      };
      let nkrvCachePromise = null;
      let nkrvIndexPromise = null;
      let currentPlan = null;
      let currentSegmentIndex = 0;

      function populateSelectors() {
        // Populate Weeks
        Object.keys(readingPlan).forEach((week) => {
          const option = document.createElement("option");
          option.value = week;
          option.textContent = week;
          weekSelect.appendChild(option);
        });

        // Trigger Day update
        updateDays();
      }

      function updateDays() {
        daySelect.innerHTML = "";
        const currentWeek = weekSelect.value;
        const days = readingPlan[currentWeek];

        days.forEach((reading, index) => {
          const option = document.createElement("option");
          option.value = reading; // Value is the Bible Reference (e.g., "Genesis 1-10")
          option.textContent = `Day ${index + 1}: ${reading}`;
          daySelect.appendChild(option);
        });
      }

      weekSelect.addEventListener("change", updateDays);

      function escapeHtml(value) {
        return String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
      }

      function getBookName(reference) {
        return reference.replace(/\s+\d.*$/, "").trim();
      }

      function getStartChapter(reference) {
        const match = reference.match(
          /(\d+)(?::\d+)?(?:\s*[-–]\s*\d+(?::\d+)?)?\s*$/
        );
        return match ? Number(match[1]) : null;
      }

      async function loadNkrvData() {
        if (nkrvCachePromise) {
          return nkrvCachePromise;
        }

        nkrvCachePromise = fetch(NKRV_JSON_PATH)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Failed to load NKRV data.");
            }
            return response.json();
          })
          .catch((err) => {
            nkrvCachePromise = null;
            throw err;
          });

        return nkrvCachePromise;
      }

      function buildNkrvIndex(data) {
        const books = {};

        Object.keys(data).forEach((key) => {
          const match = key.match(/^([^\d]+)(\d+):(\d+)$/);
          if (!match) {
            return;
          }

          const bookKey = match[1];
          const chapter = Number(match[2]);
          const verse = Number(match[3]);

          if (!books[bookKey]) {
            books[bookKey] = { verseCount: 0, chapters: {} };
          }

          const book = books[bookKey];
          book.verseCount += 1;
          if (!book.chapters[chapter]) {
            book.chapters[chapter] = [];
          }
          book.chapters[chapter].push(verse);
        });

        Object.values(books).forEach((book) => {
          Object.keys(book.chapters).forEach((chapter) => {
            book.chapters[chapter].sort((a, b) => a - b);
          });
        });

        return { data, books };
      }

      async function loadNkrvIndex() {
        if (nkrvIndexPromise) {
          return nkrvIndexPromise;
        }

        nkrvIndexPromise = loadNkrvData()
          .then(buildNkrvIndex)
          .catch((err) => {
            nkrvIndexPromise = null;
            throw err;
          });

        return nkrvIndexPromise;
      }

      function parseReadingReference(reference) {
        const bookName = getBookName(reference);
        const rangePart = reference.slice(bookName.length).trim();

        if (!rangePart) {
          return { bookName, startChapter: 1, endChapter: 1 };
        }

        const [startRaw, endRaw] = rangePart
          .split("-")
          .map((part) => part.trim());
        const startChapter = Number(startRaw.split(":")[0]);
        const endChapter = Number((endRaw || startRaw).split(":")[0]);

        return {
          bookName,
          startChapter: startChapter || null,
          endChapter: endChapter || startChapter || null,
        };
      }

      function buildSegments(reference, index) {
        const { bookName, startChapter, endChapter } =
          parseReadingReference(reference);
        const bookKey = BOOK_MAP[bookName];

        if (!bookKey) {
          throw new Error(`Unsupported book name: ${bookName}`);
        }

        const bookData = index.books[bookKey];
        if (!bookData) {
          throw new Error(`Book not found in NKRV data: ${bookName}`);
        }

        if (!startChapter || !endChapter) {
          throw new Error(`Invalid reference: ${reference}`);
        }

        const verses = [];
        for (let chapter = startChapter; chapter <= endChapter; chapter += 1) {
          const verseNumbers = bookData.chapters[chapter];
          if (!verseNumbers) {
            continue;
          }
          verseNumbers.forEach((verse) => {
            verses.push({ chapter, verse });
          });
        }

        if (!verses.length) {
          throw new Error(`No verses found for: ${reference}`);
        }

        const chapterCount = Object.keys(bookData.chapters).length;
        const isSingleChapter = chapterCount === 1;
        const halfBookLimit = isSingleChapter
          ? 500
          : Math.floor(bookData.verseCount / 2);
        const maxVerses = Math.min(500, halfBookLimit || 500);

        const segments = [];
        for (let i = 0; i < verses.length; i += maxVerses) {
          const chunk = verses.slice(i, i + maxVerses);
          segments.push({
            start: chunk[0],
            end: chunk[chunk.length - 1],
            length: chunk.length,
            verses: chunk,
          });
        }

        return {
          reference,
          bookName,
          bookKey,
          totalVerses: verses.length,
          maxVerses,
          segments,
          nkrvData: index.data,
        };
      }

      async function buildReadingPlan(reference) {
        const index = await loadNkrvIndex();
        return buildSegments(reference, index);
      }

      function formatEsvQuery(bookName, segment) {
        const startRef = `${segment.start.chapter}:${segment.start.verse}`;
        const endRef = `${segment.end.chapter}:${segment.end.verse}`;
        const range = startRef === endRef ? startRef : `${startRef}-${endRef}`;
        return `${bookName} ${range}`;
      }

      function getSegmentRange(plan, segmentIndex) {
        const priorCount = plan.segments
          .slice(0, segmentIndex)
          .reduce((sum, seg) => sum + seg.length, 0);
        const start = priorCount + 1;
        const end = start + plan.segments[segmentIndex].length - 1;
        return { start, end };
      }

      async function fetchEsv(query) {
        const params = new URLSearchParams({
          q: query,
          "include-passage-references": "false",
          "include-verse-numbers": "true",
          "include-first-verse-numbers": "true",
          "include-footnotes": "false",
          "include-headings": "false",
          "include-short-copyright": "true",
          "line-length": "0",
        });

        const response = await fetch(`${ESV_API_URL}?${params.toString()}`);
        if (!response.ok) {
          throw new Error(`ESV API error (${response.status})`);
        }
        return response.json();
      }

      function parseEsvPassages(passages, fallbackReference) {
        const raw = Array.isArray(passages) ? passages.join("\n").trim() : "";
        const startChapter = getStartChapter(fallbackReference);
        if (!raw) {
          return {
            items: [
              {
                type: "verse",
                ref: fallbackReference,
                esv: "No passage returned from the API.",
              },
            ],
          };
        }

        const tokenRegex = /\[(\d+(?::\d+)?)\]/g;
        const verses = [];
        let match;
        let lastLabel = null;
        let lastIndex = 0;

        while ((match = tokenRegex.exec(raw)) !== null) {
          if (lastLabel !== null) {
            const text = raw
              .slice(lastIndex, match.index)
              .replace(/\s+/g, " ")
              .trim();
            if (text) {
              verses.push({ label: lastLabel, esv: text });
            }
          }
          lastLabel = match[1];
          lastIndex = match.index + match[0].length;
        }

        if (lastLabel !== null) {
          const text = raw.slice(lastIndex).replace(/\s+/g, " ").trim();
          if (text) {
            verses.push({ label: lastLabel, esv: text });
          }
        }

        if (!verses.length) {
          return {
            items: [
              {
                type: "verse",
                ref: fallbackReference,
                esv: raw.replace(/\s+/g, " ").trim(),
                chapter: startChapter,
                verse: null,
              },
            ],
          };
        }

        const items = [];
        let currentChapter = startChapter;
        let verseCount = 0;

        if (currentChapter) {
          items.push({
            type: "chapter",
            label: `Chapter ${currentChapter}`,
          });
        }

        verses.forEach((verse) => {
          let verseNumber = null;
          let chapterNumber = null;

          if (verse.label.includes(":")) {
            const [chapter, versePart] = verse.label.split(":");
            chapterNumber = Number(chapter);
            verseNumber = Number(versePart);
          } else {
            verseNumber = Number(verse.label);
          }

          if (Number.isFinite(chapterNumber)) {
            if (chapterNumber !== currentChapter) {
              currentChapter = chapterNumber;
              items.push({
                type: "chapter",
                label: `Chapter ${currentChapter}`,
              });
            }
          } else if (verseNumber === 1 && verseCount > 0 && currentChapter) {
            currentChapter += 1;
            items.push({
              type: "chapter",
              label: `Chapter ${currentChapter}`,
            });
          }

          items.push({
            type: "verse",
            ref: verse.label,
            esv: verse.esv,
            chapter: currentChapter,
            verse: Number.isFinite(verseNumber) ? verseNumber : null,
          });
          verseCount += 1;
        });

        return { items };
      }

      // 3. ESV Data Fetcher
      async function fetchSegment(plan, segmentIndex) {
        const segment = plan.segments[segmentIndex];
        const query = formatEsvQuery(plan.bookName, segment);

        let data = null;
        let esvError = null;

        try {
          data = await fetchEsv(query);
        } catch (err) {
          console.warn("ESV fetch failed, using fallback mode:", err);
          esvError = err;
        }

        // If ESV worked, use the parsed passages
        if (data) {
          const parsed = parseEsvPassages(
            data.passages,
            data.canonical || query
          );

          return {
            title: plan.reference,
            query: data.canonical || query,
            items: parsed.items.map((item) => {
              if (item.type !== "verse") {
                return item;
              }

              const nkrvKey =
                plan.bookKey && item.chapter && item.verse
                  ? `${plan.bookKey}${item.chapter}:${item.verse}`
                  : null;
              const nkrvText =
                nkrvKey && plan.nkrvData[nkrvKey]
                  ? plan.nkrvData[nkrvKey].trim()
                  : "";

              return {
                ...item,
                nkrv: nkrvText,
              };
            }),
          };
        }

        // FALLBACK: Generate items from segment.verses directly
        const items = [];
        let currentChapter = null;

        segment.verses.forEach((v) => {
          // Add chapter header if needed
          if (v.chapter !== currentChapter) {
            currentChapter = v.chapter;
            items.push({
              type: "chapter",
              label: `Chapter ${currentChapter}`,
            });
          }

          const nkrvKey = `${plan.bookKey}${v.chapter}:${v.verse}`;
          const nkrvText = plan.nkrvData[nkrvKey]
            ? plan.nkrvData[nkrvKey].trim()
            : "";

          items.push({
            type: "verse",
            ref: `${v.verse}`, // Simple ref format
            esv: "ESV text unavailable (API error)", // Fallback text
            chapter: v.chapter,
            verse: v.verse,
            nkrv: nkrvText,
            isFallback: true, // Marker for styling if needed
          });
        });

        return {
          title: plan.reference,
          query: query,
          items: items,
        };
      }

      async function renderSegment() {
        if (!currentPlan) {
          return;
        }

        const totalSegments = currentPlan.segments.length;
        const segmentLabel = `${currentSegmentIndex + 1} of ${totalSegments}`;
        const { start, end } = getSegmentRange(
          currentPlan,
          currentSegmentIndex
        );

        contentArea.innerHTML = `<div class="loading">Loading verses...</div>`;
        let result;
        try {
          result = await fetchSegment(currentPlan, currentSegmentIndex);
        } catch (err) {
          contentArea.innerHTML = `<div class="error">Error loading content. Please try again.</div>`;
          console.error(err);
          return;
        }

        let html = `
          <div class="reading-header">
            <h2>Reading: ${escapeHtml(currentPlan.reference)}</h2>
            <p class="reading-sub">
              Showing verses ${start}-${end} of ${currentPlan.totalVerses}
              (Part ${segmentLabel}) • ESV via API • NKRV local JSON
            </p>
          </div>
        `;

        if (totalSegments > 1) {
          const prevDisabled = currentSegmentIndex === 0 ? "disabled" : "";
          const nextDisabled =
            currentSegmentIndex === totalSegments - 1 ? "disabled" : "";
          html += `
            <div class="segment-controls">
              <button id="prevSegment" ${prevDisabled}>Previous</button>
              <span class="segment-info">Part ${segmentLabel}</span>
              <button id="nextSegment" ${nextDisabled}>Next</button>
            </div>
          `;
        }

        if (currentPlan.totalVerses > currentPlan.maxVerses) {
          html += `
            <div class="limit-note">
              ESV API limits require paging: max ${currentPlan.maxVerses} verses
              per request/page.
            </div>
          `;
        }

        // --- RENDER BY CHAPTER CARD ---
        let currentChapterHtml = "";
        let isCardOpen = false;
        let cardCount = 0;

        const closeCard = () => {
          if (isCardOpen) {
            html += `<div class="chapter-card-content">`;
            html += currentChapterHtml; // Add verses
            html += `</div>`; // Close .chapter-card-content
            html += `</div>`; // Close .chapter-card
            currentChapterHtml = "";
            isCardOpen = false;
          }
        };

        const openCard = (label) => {
          closeCard();
            cardCount++;
          // First card is open (no class), others are collapsed
          const collapsedClass = cardCount === 1 ? "" : "collapsed";

          html += `<div class="chapter-card ${collapsedClass}">`;
          html += `
            <div class="chapter-card-header" onclick="this.parentElement.classList.toggle('collapsed')">
              ${escapeHtml(label)}
              <svg class="toggle-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
          `;
          isCardOpen = true;
        };

        result.items.forEach((item) => {
          if (item.type === "chapter") {
            openCard(item.label);
            return;
          }

          // If we encounter a verse but no card is open (e.g. start of passage without explicit chapter change), open one
          if (!isCardOpen) {
            openCard(`Chapter ${item.chapter || "?"}`);
          }

          const nkrvText = item.nkrv || "NKRV text not found for this verse.";
          const nkrvClass = item.nkrv ? "text-nkrv" : "text-nkrv placeholder";

          // If fallback mode (ESV failed), don't show the ESV block at all
          const esvHtml = item.isFallback
            ? ""
            : `<div class="text-esv">${escapeHtml(item.esv)}</div>`;

          currentChapterHtml += `
            <div class="verse-container">
              <div class="verse-number">${escapeHtml(item.ref)}</div>
              <div class="verse-text">
                ${esvHtml}
                <div class="${nkrvClass}">${escapeHtml(nkrvText)}</div>
              </div>
            </div>
          `;
        });

        closeCard(); // Close any remaining card
        // --- END RENDER ---

        html += `
          <div class="copyright-note">
            Scripture quotations are from the ESV® Bible (The Holy Bible, English
            Standard Version®), copyright © 2001 by Crossway, a publishing
            ministry of Good News Publishers. Used by permission. All rights
            reserved.
          </div>
        `;

        contentArea.innerHTML = html;

        const prevButton = document.getElementById("prevSegment");
        if (prevButton) {
          prevButton.addEventListener("click", async () => {
            if (currentSegmentIndex > 0) {
              currentSegmentIndex -= 1;
              await renderSegment();
            }
          });
        }

        const nextButton = document.getElementById("nextSegment");
        if (nextButton) {
          nextButton.addEventListener("click", async () => {
            if (currentSegmentIndex < totalSegments - 1) {
              currentSegmentIndex += 1;
              await renderSegment();
            }
          });
        }
      }

      // 4. Render Logic
      loadBtn.addEventListener("click", async () => {
        const reference = daySelect.value;

        // Show Loading
        contentArea.innerHTML = `<div class="loading">Preparing reading for ${reference}...</div>`;

        try {
          currentPlan = await buildReadingPlan(reference);
          currentSegmentIndex = 0;
          await renderSegment();
        } catch (err) {
          contentArea.innerHTML = `<div class="error">Error loading content. Please try again.</div>`;
          console.error(err);
        }
      });

      // Start
      populateSelectors();
    </script>
  </body>
</html>
